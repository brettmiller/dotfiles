#ATUIN_LIMIT=20000
CUR_SHELL=$(basename $SHELL)
FZF_TMUX_HEIGHT="100%"

# atuin+fzf - modified from https://news.ycombinator.com/item?id=35256206, keeps atuin bindkey and uses ctrl-e for fzf+atuin
# original lines are commented w/ new line below
atuin-setup() {
        if ! which atuin &> /dev/null; then return 1; fi
        #bindkey '^E' _atuin_search_widget
        bindkey '^R' _atuin_search_widget

        export ATUIN_NOBIND="true"
        eval "$(atuin init "$CUR_SHELL")"
        fzf-atuin-history-widget() {
            local selected num
            setopt localoptions noglobsubst noposixbuiltins pipefail no_aliases 2>/dev/null

            # local atuin_opts="--cmd-only --limit ${ATUIN_LIMIT:-5000}"
            local atuin_opts="--cmd-only"
            local fzf_opts=(
                --height=${FZF_TMUX_HEIGHT:-80%}
                --tac
                "-n2..,.."
                --tiebreak=index
                "--query=${LBUFFER}"
                "+m"
                #"--bind=ctrl-d:reload(atuin search $atuin_opts -c $PWD),ctrl-r:reload(atuin search $atuin_opts)"
                "--bind=ctrl-d:reload(atuin search $atuin_opts -c $PWD),ctrl-e:reload(atuin search $atuin_opts)"
            )

            selected=$(
                eval "atuin search ${atuin_opts}" |
                    fzf "${fzf_opts[@]}"
            )
            local ret=$?
            if [ -n "$selected" ]; then
                # the += lets it insert at current pos instead of replacing
                LBUFFER+="${selected}"
            fi
            zle reset-prompt
            return $ret
        }
        zle -N fzf-atuin-history-widget
        #bindkey '^R' fzf-atuin-history-widget
        #bindkey '^E' fzf-atuin-history-widget # this overrides ^E end-of-line
        bindkey '^Xr' fzf-atuin-history-widget # overrides history-incremental-search-backward which I don't use
    }
    atuin-setup

